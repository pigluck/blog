<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>忘记密码</title>
<link type="text/css" href="__INDEX__/css/findpass.css" rel="stylesheet" />
 <link type="text/css" rel="stylesheet" href="__INDEX__/css/slide-unlock.css">
<!--<script src="__INDEX__/js/jquery.min.js" type="text/javascript"></script>-->
<script src="__INDEX__/js/jquery.min.js"></script>
<script src="__INDEX__/js/jquery.validate.min.js"></script>

 <script type="text/javascript" src="__INDEX__/js/jquery.slideunlock.js"></script>
 <script type="text/javascript" src="__INDEX__/js/md5.js"></script>
</head>

<body>
 
  <div class="content">
   <div class="web-width">
     <div class="for-liucheng">
      <div class="liulist for-cur"></div>
      <div class="liulist"></div>
      <div class="liulist"></div>
      <div class="liutextbox">
       <div class="liutext for-cur"><em>1</em><br /><strong>验证用户名</strong></div>
       <!--<div class="liutext"><em>2</em><br /><strong>验证身份</strong></div>-->
       <div class="liutext"><em>2</em><br /><strong>设置新密码</strong></div>
       <div class="liutext"><em>3</em><br /><strong>完成</strong></div>
      </div>
     </div><!--for-liucheng/-->
     <form class="forget-pwd form1" id="form1">
       <dl>
        <dt>账户名：</dt>
        <dd><input type="text" required maxlength="20" name="username"/></dd>
        <input type="hidden" name="state" value="{$state}">
        <div class="clears"></div>
       </dl> 
       <dl>
        <dt>验证码：</dt>
        <dd>
         <input type="hidden" name="code" required/>
         <div id="slider">
          <div id="slider_bg"></div>
          <span id="label">>></span> <span id="labelTip">拖动滑块验证</span>
         </div>
        </dd>
        <div class="clears"></div>
       </dl>
       <div class="subtijiao"><input type="submit" value="提交" /></div> 
      </form><!--forget-pwd/-->


      <form class="forget-pwd form2" id="form2">

       <dl style="display: none;">
        <dt></dt>
        <dd><input type="hidden" value="" name="user" id="user"/></dd>
        <div class="clears"></div>
       </dl>
       <dl>
        <dt>新密码：</dt>
        <dd><input type="password" name="password" id="password" class="password"/></dd>
        <div class="clears"></div>
       </dl>
       <dl>
        <dt>确认密码：</dt>
        <dd><input type="password" name="confirmpwd"/></dd>
        <div class="clears"></div>
       </dl>
       <dl class="sel-yzsj">
        <dt>已验证手机：</dt>
        <dd><input type="text" value="" name="tel" id="tel"/><input style="float: right;width: 100px;cursor: pointer;" onclick="return check_phone();" value="获取短信验证码" id="submitCode"></dd>
        <div class="clears"></div>
       </dl>
       <!--<dl class="sel-yzyx">-->
        <!--<dt>已验证邮箱：</dt>-->
        <!--<dd><input type="text" value="764852123@qq.com" readonly /></dd>-->
        <!--<div class="clears"></div>-->
       <!--</dl>-->
       <dl>
        <dt>手机校验码：</dt>
        <dd><input type="text" name="smscode" id="smscode" maxlength="6"/> </dd>
        <div class="clears"></div>
       </dl>
       <div class="subtijiao"><input type="submit" value="提交" /></div> 
      </form>

      <div class="successs">
       <h3>恭喜您，修改成功！</h3>
      </div>
   </div><!--web-width/-->
  </div><!--content/-->
  
</body>
<script type="text/javascript">
 $(document).ready(function() {
  $("#form1").validate({
   rules: {
    username: {
     required: true,
     minlength: 3,
     maxlength: 20,
     remote: {
      url: "/logincheckuser",
      type: "post",
     },
    },
    code: {
     required: true,
    },
   },
   messages: {
    username: {
     required: "必须填写用户名",
     minlength: "用户名至少为3个字符",
     maxlength: "用户名至多为20个字符",
     remote: "用户名不存在",
    },
    code: {
     required: "请先完成验证",
    },
   },
   submitHandler:function(form){
    var name = $("[name='username']").val();
    var state = $("[name='state']").val();
    // alert(name+state);
    $.post('/findstept',{username:name,step:state},function(data){
     data = eval('('+data+')');
     if (data.code == "00") {
      $("#form1").css('display','none');
      $("#form2").css('display','block');
      $(".liulist").eq(1).addClass('for-cur');
      $(".liutext").eq(1).addClass('for-cur');
      $("[name='user']").val(data.msg);
      $("[name='tel']").val(data.tel);
     }else{
      alert(data.msg);
     }
    });
   },
  });

     $("#form2").validate({
         rules: {
             password: {
                 required: true,
                 minlength: 6,
                 maxlength: 16,
             },
             confirmpwd: {
                 required: true,
                 minlength: 6,
                 equalTo: '.password'
             },
             smscode: {
                 required: true,
                 maxlength: 6,
                 // digits: true,
             }
         },
         messages: {
             password: {
                 required: "必须填写密码",
                 minlength: "密码至少为6个字符",
                 maxlength: "密码至多为16个字符",
             },
             confirmpwd: {
                 required: "请再次输入密码",
                 minlength: "两次输入密码不一致",
                 equalTo: "两次输入密码不一致",
             },
             smscode: {
                 required: "请输入验证码",
                 maxlength: "验证码为6位",
             },
         },
         submitHandler:function(form){
             var name = $('#user').val();
             var pwd = hex_md5($('#password').val());
             var phone = $('#tel').val();
             var code = $('#smscode').val();
             $.post('/findcheckCode',{state:name,tel:phone,password:pwd,smscode:code},function(data){
                 // alert('验证码错误');
                 data = eval('('+data+')');
                 // alert(data.msg);
                 if (data.code == "00") {
                     // window.location.href = '/';
                     $("#form2").css('display','none');
                     $(".successs").css('display','block');
                     $(".liulist").eq(2).addClass('for-cur');
                     $(".liutext").eq(2).addClass('for-cur');
                     setTimeout(function () {
                         window.location.href='/';
                     },2000)
                 }else{
                     alert(data.msg);
                 }
             });
         },
     });
 });

</script>
<script>
 $(function () {
  var slider = new SliderUnlock("#slider",{
   successLabelTip : "验证成功"
  },function(){
    $("[name='code']").val('ok');
  });
  slider.init();
 })
</script>
<script type="text/javascript">
    function check_phone(){
        var phone = document.getElementById('tel').value;
        if(!(/^1[34578]\d{9}$/.test(phone))){
            // $("#number-error").css('display','block');
            alert('请输入合法手机号');
        }else{
            // $("#number-error").css('display','none');
            codeButton();
            $.post('{:url("index/findpwd/sendsms")}',{tel:phone},function(data){alert(data);});
        }
        return false;
    }

    function codeButton(){
        var code = $("#submitCode");
        code.attr("disabled","disabled");
        setTimeout(function(){
            code.css("opacity","0.8");
            code.css('background-color',"#A9A9A9")
        },1000)
        var time = 60;
        var set=setInterval(function(){
            code.val("重新发送("+--time+")");
        }, 1000);
        setTimeout(function(){
            code.attr("disabled",false).val("重新发送");
            code.css('background-color','rgb(6,152,224)');
            clearInterval(set);
        }, 60000);
    }
</script>
</html>
